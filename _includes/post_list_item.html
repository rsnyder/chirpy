{% assign post = include.post %}

<article class="card-wrapper card">
  <a href="{{ post.url | relative_url }}" class="post-preview row g-0 flex-md-row-reverse">
    {% assign card_body_col = '12' %}

    {% if post.image %}

    {% assign raw_src = post.image.path | default: post.image %}

    {%- capture src -%}
    {%- include url_from_src.html src=raw_src media_subpath=post.media_subpath mw_width=360 -%}
    {%- endcapture -%}
    {%- assign src = src | strip -%}

    {%- assign commons_thumb_prefix = "https://upload.wikimedia.org/wikipedia/commons/thumb" -%}

    {%- assign do_resize = true -%}

    {%- if post.image.resize == false -%}
    {%- assign do_resize = false -%}
    {%- elsif src contains commons_thumb_prefix -%}
    {%- assign do_resize = false -%}
    {%- endif -%}

    {%- if do_resize -%}
    {%- assign base = "https://res.cloudinary.com/dmceci9t1/image/fetch/" -%}
    {%- assign transform_safe = "w_360,h_190" -%}
    {%- assign src_safe = src | url_encode -%}
    {%- assign final_src = base | append: transform_safe | append: "/" | append: src_safe -%}
    {%- else -%}
    {%- assign final_src = src -%}
    {%- endif -%}

    {% if post.image.lqip %}
    {% assign lqip = post.image.lqip %}

    {% if post.media_subpath %}
    {% unless lqip contains 'data:' %}
    {% assign lqip = post.media_subpath
    | append: '/'
    | append: lqip
    | replace: '///', '/'
    | replace: '//', '/'
    %}
    {% endunless %}
    {% endif %}

    {% assign lqip_attr = 'lqip="' | append: lqip | append: '"' %}
    {% endif %}

    {% assign alt = post.image.alt | xml_escape | default: 'Preview Image' %}

    <div class="col-md-5">
      <img src="{{ final_src }}" alt="{{ alt }}" {{ lqip_attr }}>
    </div>

    {% assign card_body_col = '7' %}
    {% endif %}

    <div class="col-md-{{ card_body_col }}">
      <div class="card-body d-flex flex-column">
        <h1 class="card-title my-2 mt-md-0">{{ post.title }}</h1>

        <div class="card-text content mt-0 mb-3">
          <p>{% include post-summary.html %}</p>
        </div>

        <div class="post-meta flex-grow-1 d-flex align-items-end">
          <div class="me-auto">
            <!-- posted date -->
            <i class="far fa-calendar fa-fw me-1"></i>
            {% include datetime.html date=post.date lang=lang %}

            <!-- categories -->
            {% if post.categories.size > 0 %}
            <i class="far fa-folder-open fa-fw me-1"></i>
            <span class="categories">
              {% for category in post.categories %}
              {{ category }}
              {%- unless forloop.last -%},{%- endunless -%}
              {% endfor %}
            </span>
            {% endif %}
          </div>

          {% if post.pin %}
          <div class="pin ms-1">
            <i class="fas fa-thumbtack fa-fw"></i>
            <span>{{ site.data.locales[lang].post.pin_prompt }}</span>
          </div>
          {% endif %}
        </div>
        <!-- .post-meta -->
      </div>
      <!-- .card-body -->
    </div>
  </a>
</article>